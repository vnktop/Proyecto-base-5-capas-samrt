
similarproducts.vulcon  =
{
	$: spsupport.p.$,
	appDomain: spsupport.p.sfDomain,
	hostDomain: null,
    whiteList: /^(4gtricks\.com|800notes\.com|9gag\.com|9to5google\.com|9to5mac\.com|about\.com|acme\.com|addictivetips\.com|adultswim\.com|afterdawn\.com|aiche\.org|alatest\.com|allmyfaves\.com|allthetests\.com|alvinalexander\.com|amazingsuperpowers\.com|androidcentral\.com|androidfreeware\.mobi|androidguys\.com|androidheadlines\.com|androidpit\.com|androidpolice\.com|androidspin\.com|answers\.com|antennasearch\.com|aol\.com|appcrawlr\.com|applegazette\.com|appsafari\.com|appsgeyser\.com|arstechnica\.com|artoftheiphone\.com|aruljohn\.com|askabouttech\.com|askdavetaylor\.com|awkwardfamilyphotos\.com|baidu\.com|bestappsite\.com|betanews\.com|bgr\.com|bored\.com|boredbutton\.com|brainfall\.com|break\.com|bromygod\.com|buttersafe\.com|cad-comic\.com|cakewrecks\.com|caribbeancinemas\.com|cellreception\.com|cheezburger\.com|chromecasthelp\.net|chzbgr\.com|clientsfromhell\.net|cnn\.com|codeproject\.com|collegehumor\.com|computerhope\.com|computerperformance\.co\.uk|convergedigest\.com|cracked\.com|cultofandroid\.com|cultofmac\.com|dailyfailcenter\.com|dailymotion\.com|damnlol\.com|deadcellzones\.com|dedoimedo\.com|deviantart\.com|dilbert\.com|dingbatty\.com|dottech\.org|download\.com|downloadcrew\.com|downloadpipe\.com|droid-life\.com|droidgamers\.com|dseffects\.com|dumpaday\.com|ebaumsworld\.com|ehowa\.com|electronista\.com|elijahhardin\.com|eudownloads\.com|evilmilk\.com|eweek\.com|excite\.com|exler\.ru|fanfiction\.net|fark\.com|file\.org|filebuzz\.com|filehippo\.com|filehorse\.com|fileinfo\.com|filext\.com|findbestopensource\.com|fishki\.net|fjcdn\.com|flickr\.com|fmylife\.com|foxnews\.com|freeswitch\.org|freewarefiles\.com|funformobile\.com|funnyjunk\.com|funnymama\.com|funnytear\.com|gadgetwide\.com|garyshood\.com|getgreenshot\.org|gethuman\.com|ghacks\.net|gigaom\.com|giveawayoftheday\.com|go\.com|goo\.im|gorillamask\.net|gotoquiz\.com|gottabemobile\.com|groovypost\.com|guff\.com|guidingtech\.com|gunshowcomic\.com|guruslodge\.com|hackinguniversity\.in|helpdeskgeek\.com|homestarrunner\.com|howstuffworks\.com|howtogeek\.com|huffingtonpost\.com|i-am-bored\.com|idownloadblog\.com|iemoji\.com|ifaketext\.com|ifans\.com|ifunny\.mobi|ilovefreesoftware\.com|ilyke\.net|imdb\.com|imgur\.com|imore\.com|informer\.com|intowindows\.com|iosnoops\.com|ipadforums\.net|ipadinsight\.com|iphone-developers\.com|iphonecaptain\.com|iphonedevsdk\.com|iphonelife\.com|iphoneness\.com|ithemesky\.com|itjungle\.com|itnews\.com|iwastesomuchtime\.com|izismile\.com|japaneseemoticons\.net|jdownloader\.org|jibjab\.com|jokes4us\.com|joyreactor\.com|junauza\.com|knowyourmeme\.com|knowyourmobile\.com|komando\.com|labnol\.org|lamebook\.com|learningsharepoint\.com|leasticoulddo\.com|lifeinlofi\.com|linkedin\.com|liutilities\.com|live\.com|lolsnaps\.com|lovelysms\.com|maclife\.com|macmost\.com|macnn\.com|macrumors\.com|mainframewizard\.com|makeuseof\.com|mandatory\.com|mcsweeneys\.net|mediahuman\.com|mediatakeout\.com|memecenter\.com|memegenerator\.net|microsoft\.com|mob\.org|mobikills\.com|mobile9\.com|mobiles24\.com|mobilesyrup\.com|modmyi\.com|mrkent\.com|msfn\.org|msn\.com|mspaintadventures\.com|mugshots\.com|myhughesnet\.com|n1wireless\.com|nchsoftware\.com|nerdsmagazine\.com|nickmom\.com|nirsoft\.net|notalwaysright\.com|notalwaysworking\.com|nytimes\.com|oddee\.com|oldapps\.com|oldversion\.com|online-convert\.com|online-tech-tips\.com|opensoftwareupdater\.com|osalt\.com|pandaapp\.com|pandora\.com|pbfcomics\.com|pcworld\.com|peeplo\.com|peopleofwalmart\.com|phandroid\.com|phonearena\.com|phonenews\.com|phonescoop\.com|pleated-jeans\.com|pof\.com|pophangover\.com|popherald\.com|portablefreeware\.com|prankdial\.com|product-reviews\.net|pubmatic\.com|quibblo\.com|quickmeme\.com|qwantz\.com|radio-electronics\.com|razorianfly\.com|reactiongifs\.com|redferret\.net|redmondpie\.com|ringostation\.com|roblox\.com|roosterteeth\.com|runt-of-the-web\.com|sadanduseless\.com|satwcomic\.com|screencast-o-matic\.com|shareme\.com|shinyshiny\.tv|shortcutworld\.com|simonblog\.com|simplehelp\.net|sinfest\.net|skjm\.com|slashgear\.com|smackjeeves\.com|smartappsforkids\.com|smosh\.com|snafu-comics\.com|soft112\.com|softpedia\.com|softwareok\.com|somethingawful\.com|sourceforge\.net|storypick\.com|systemexplorer\.net|tagged\.com|tastefullyoffensive\.com|tech-recipes\.com|tech4mommies\.com|techdows\.com|techiecorner\.com|techlicious\.com|technobuffalo\.com|techpp\.com|techrepublic\.com|techrepublic\.com\.com|techsupportalert\.com|techulator\.com|tek-tips\.com|text-image\.com|textem\.net|thatguywiththeglasses\.com|theapptimes\.com|thechive\.com|thedailywtf\.com|thedoghousediaries\.com|thedroidlawyer\.com|theinquirer\.net|theitbros\.com|themetapicture\.com|thenextweb\.com|theonion\.com|thepcsecurity\.com|thepiratebay\.se|thewindowsclub\.com|thewrap\.com|tickld\.com|tmonews\.com|tmxmoney\.com|tomsguide\.com|tomsitpro\.com|tones7\.com|totalsororitymove\.com|transformerforums\.com|tumblr\.com|tweakguides\.com|tweaking\.com|txt2day\.com|txtdrop\.com|uberhumor\.com|ubuntuupdates\.org|uclick\.com|umnet\.com|unixmen\.com|updatestar\.com|usvsth3m\.com|vuclip\.com|wallpaperswide\.com|weather\.com|webopedia\.com|webpagetest\.org|webupd8\.org|weightwatchers\.com|weknowmemes\.com|whatthetech\.com|whycall\.me|wildammo\.com|windstream\.net|winhelp\.us|winning-play\.com|winscp\.net|wirelessforums\.org|wonderhowto\.com|wordcountertool\.com|xda-developers\.com|xkcd\.com|yahoo\.com|yakitome\.com|yaplakal\.com|youtube\.com|zdnet\.com|zedge\.net)$/i,
    pageWhiteList: /hyperboleandahalf\.blogspot\.com|download\.cnet\.com|news\.google\.com/i,
	serverLayerFrame: null,
	minimizedMode: false,
	initialMinimizingTimer: null,
	urlParams:{},
    showed:false,

	serverData:
	{
		sessionId: null
	},

	view:
	{
		self: null
	},

	initialize: function()
	{
		this.hostDomain = this.utils.extractDomainName(location.host);

		if (this.isNeedToShowAd() && (this.whiteList.test(this.hostDomain) || this.pageWhiteList.test(location.href)))
		{
			this.startFlow();
		}
	},

	startFlow: function()
	{
		var sb = similarproducts.b;
        this.urlParams = this.parseUrlParams(location.search.substring(1));

        var domainName = this.utils.extractDomainName(document.location.host);
		var serverLayerFrameParams =
		{
            userId : sb.userid,
			version: sb.appVersion
		};

		sb.inj(document, this.appDomain+'vulcon/css/main.css?v='+sb.appVersion);

		this.$(window).bind("message", this.utils.serverMessagesRouter.bind(this));

		this.serverLayerFrame = this.$('<iframe />',
		{
			style: 'position:absolute; width:0; height:0; left:-100px; top:-100px;',
			src: this.appDomain + 'vulcon/server_layer.html?' + this.utils.compileQueryString(serverLayerFrameParams) + similarproducts.utilities.abTestUtil.getDataString()
		})[0];

		document.body.appendChild(this.serverLayerFrame);
	},


    parseUrlParams: function(urlParams)
    {
        var result = {};
        var param;

        urlParams = urlParams.split('&');

        for (var i=0, l=urlParams.length; i<l; i++)
        {
            param = urlParams[i].split('=');

            result[param[0]] = decodeURIComponent(param[1]);
        }

        return result;
    },

	processServerData: function(data) // This function is called by the "utils.serverMessagesRouter" func via the "fn" param send by the server layer
	{
	    if(this.isNeedToShowAd()){
            this.serverData = data;

            similarproducts.Template.initialize(data.template);

            this.render();
            this.defineViewElements();
            this.renderInfo();
            this.postRender();
            this.activate();
	    }
	},

	render: function()
	{
        var sb = similarproducts.b;
        var domainName = this.utils.extractDomainName(document.location.host);

        var params = {
            sourceDomain : this.appDomain,
            userid : sb.userid,
            ctid: sb.CD_CTID,
            sessionid : this.serverData.sessionId,
            browser : spsupport.api.dtBr(),
            page_url : location.href,
            merchantName : domainName,
            dlsource : sb.dlsource,
            ip : sb.ip,
            clientCountry : sb.userData.uc
        }

	    var reportParamsString =  this.utils.compileQueryString(params);
	    reportParamsString += similarproducts.utilities.abTestUtil && similarproducts.utilities.abTestUtil.getDataString() || '';

        var url =  'https://samsbox.com/getoffers?' + reportParamsString +'&publisherId=19&publisherKey=a7ac8d2e4c132fab10abf491cc0a987487a5c676&responseType=widget';

		var item = {};
        item.iframeSrc = url;
        item.name = 'Free apps';

		this.$('body').append(similarproducts.Template.render('vulconMain',
		{
			partnerName: this.urlParams.partnername ? similarproducts.b.encodeDecode(false,this.urlParams.partnername) : similarproducts.b.psuSupportedByText,
			item: item
		}));

        this.reportAction({action: 'vulcon iframe called'});
	},

	defineViewElements: function()
	{
		this.view.self = this.$('#similarproducts_vulcon'),
		this.view.unitHeader = this.$('._unit_header', this.view.self),
		this.view.closeButton = this.$('._close', this.view.self),
		this.view.minimizeButton = this.$('._minimize', this.view.self),
		this.view.restoreButton = this.$('._restore', this.view.self),
		this.view.infoButton = this.$('._show_info', this.view.self),
		this.view.disableButton = this.$('._disable', this.view.self)
	},

	postRender: function()
	{
		if (this.$.browser.msie && parseInt(spsupport.p.$.browser.version) < 10)
		{
			this.view.self.addClass('legacy_browser');
		}
	},

	activate: function()
	{
		this.view.self.one('mouseover', this.cancelInitialMinimizing.bind(this));
		this.view.infoButton.click(this.showInfo.bind(this));
		this.view.closeButton.click(this.closeUnit.bind(this));
		this.view.minimizeButton.click(this.minimizeUnit.bind(this, 'mini'));
		this.view.unitHeader.mouseenter(this.unCloseUnit.bind(this));
		this.view.restoreButton.click(this.restoreUnit.bind(this));
		this.view.disableButton.click(this.disableUnit.bind(this));
	},

	cancelInitialMinimizing: function()
	{
		if (this.initialMinimizingTimer)
		{
			clearTimeout(this.initialMinimizingTimer);

			this.initialMinimizingTimer = null;
		}
	},

	isUnitMinimized: function()
	{
		var minimizedTimestamp = parseInt(localStorage.getItem('__sfVulconModuleMinimized')) || 0;

		if (this.utils.isTimestampInRange(minimizedTimestamp, 86400000)) // 24hours
		{
			return true;
		}
	},

	isUnitSuperMinimized: function()
	{
		if (this.utils.isTimestampInRange(this.serverData.closedTimestamp, 86400000)) // 24hours
		{
			return true;
		}
	},


	positionToView: function()
	{
	    if(!this.isNeedToShowAd()){
            this.reportAction({action: 'vulconNoNeedToShow',dscr: similarproducts.utilities.getActiveUnits()});
            return;
	    }

        similarproducts.utilities.newUnit('vulcon');
        this.showed = true;
        this.utils.sendMessageToServerLayer.call(this, 'adShowed');
		var unitHeight = this.view.self.height();
		var unitFinalPosition = 0;

		if (this.isUnitSuperMinimized())
		{
			this.minimizedMode = 'supermini';
			unitFinalPosition = -(unitHeight-5);
		}
		else
		{
			if (this.isUnitMinimized())
			{
				this.minimizedMode = 'mini';
				this.view.self.addClass('minimized');
				unitFinalPosition = -(unitHeight-40);
			}
			else
			{
				this.initialMinimizingTimer = setTimeout(this.autoMinimizeUnit.bind(this), 30000);
			}
		}

		this.view.self.css({bottom:-unitHeight});
		this.view.self.animate({bottom:unitFinalPosition}, 200);
        this.reportAction({action: 'vulcon showed'});
    },

	closeUnit: function()
	{
		this.utils.sendMessageToServerLayer.call(this, 'closeUnit', 'sf_close_vulcon');
		this.reportAction({action: 'vulcon hide'});
		this.hideUnit('supermini');
	},

	unCloseUnit: function()
	{
		if (this.minimizedMode == 'supermini')
		{
			this.utils.sendMessageToServerLayer.call(this, 'unCloseUnit', 'sf_close_vulcon');
			this.unHideUnit();
		}
	},

	minimizeUnit: function(mode, callback)
	{
		localStorage.setItem('__sfVulconModuleMinimized', new Date().getTime());

		this.hideUnit(mode, callback);
		(mode == 'mini') && this.reportAction({action: 'vulcon minimized'});
	},

	autoMinimizeUnit: function()
	{
		this.hideUnit('mini');
	},

	restoreUnit: function()
	{
		localStorage.removeItem('__sfVulconModuleMinimized');

		this.unHideUnit();
	},

	hideUnit: function(mode, callback) // modes: mini, supermini
	{
		var unitHeight = this.view.self.height();
		var visiblePartHeight;

		if (mode == 'mini')
		{
			visiblePartHeight = this.view.unitHeader.height();
			this.view.self.addClass('minimized');
		}
		else
		{
			visiblePartHeight = 5;
		}

		this.view.self.animate({bottom:-(unitHeight-visiblePartHeight)},
		{
			duration: 200,
			complete: callback || function(){}
		});

		this.minimizedMode = mode;
	},

	unHideUnit: function()
	{
		this.view.self.css({bottom: 0});
		this.view.self.removeClass('minimized');
		this.minimizedMode = false;

		this.reportAction({action: 'vulcon restored'});
	},

	showInfo: function()
	{
		similarproducts.info.ev(
		{
			position: 'fixed',
			left: 'auto',
			right: 15,
			bottom: 10
		}, 1, 1);

		similarproducts.info.pi("-9999" + similarproducts.b.xdMsgDelimiter + spsupport.p.initialSess);
	},

	renderInfo: function()
	{
		var info = similarproducts.info;

		info.jInfo = this.$('#' + info.infoId);

		if (info.jInfo.length == 0)
		{
			info.jInfo = this.$(info.ci(this.appDomain, similarproducts.b.dlsource, similarproducts.b.userid, similarproducts.b.CD_CTID, similarproducts.b.appVersion)).appendTo(document.body);
			info.jIfr = this.$('#' + info.infoId + '_CONTENT', info.jInfo);

			this.$('.closeButton', info.jInfo).click(function()
			{
				info.close();
			});
		}

	},

	disableUnit: function()
	{
		this.utils.sendMessageToServerLayer.call(this, 'disableUnit', 'sf_uninstall_vulcon');

		this.reportAction({action: 'vulcon disabled'});

		this.minimizeUnit('supermini', function()
		{
			this.view.self.remove();

		}.bind(this));
	},

    alreadyShowed: function()
    {
        similarproducts.sfdebugger.log('<b>No need to show vulcon Ads - already showed today</b>');
    },

    isNeedToShowAd: function ()
    {
        similarproducts.sfdebugger.log('<b>In vulcon:Active units - [' + similarproducts.utilities.getActiveUnits() + ']</b>');
	    if  (similarproducts.utilities.getActiveUnits() != ''){
	        similarproducts.sfdebugger.log('<b>No need to show Ads - [' + similarproducts.utilities.getActiveUnits() + '] Showed</b>');
	        return false;
	    } else if(this.showed || similarproducts.b.userData.uc !== 'US'){
	        return false;
        } else {
            return true;
        }
    },

    reportAction: function(data)
	{
		var pixel = new Image();
		var reportParamsString;

		data.userid = spsupport.p.userid;
		data.sessionid = this.serverData.sessionId;
        data.browser = spsupport.api.dtBr();
        data.page_url = window.location.href;
        data.merchantName = spsupport.p.siteDomain;
        data.dlsource = similarproducts.b.dlsource;
        data.country = similarproducts.b.userData.uc;
        data.ip = similarproducts.b.ip;

		reportParamsString = this.utils.compileQueryString(data);
	    reportParamsString += similarproducts.utilities.abTestUtil && similarproducts.utilities.abTestUtil.getDataString() || '';

		pixel.src = this.appDomain + 'trackSession.action?' + reportParamsString;
	}
};


similarproducts.vulcon.utils =
{
	extractDomainName: function(url)
	{
		var slicedUrl = url.toLowerCase().split('.');
        var length = slicedUrl.length;
        var tldRegex = /^(com|net|info|org|gov|co)$/; //TLD regex

        if (length > 2) // i.e. www.google.com.br, google.co.il, test.example.com
        {
            if (tldRegex.test(slicedUrl[length-2])) // Check second to last part if it passes the TLD regex.
            {
                slicedUrl.splice(0, length-3);
            }
            else
            {
                slicedUrl.splice(0, length-2);
            }
        }

        return slicedUrl.join('.');
	},

	compileQueryString: function(obj)
	{
		var result = [];

		for (key in obj)
		{
			if (obj.hasOwnProperty(key))
			{
				result.push(key + '=' + encodeURIComponent(obj[key]));
			}
		}

		return result.join('&');
	},

	concatObjects: function()
	{
		var result = {};
		var obj;

		for (var i=0, l=arguments.length; i<l; i++)
		{
			obj = arguments[i];

			for (var key in obj)
			{
				obj.hasOwnProperty(key) && (result[key] = obj[key]);
			}
		}

		return result;
	},

	isTimestampInRange: function(timestamp, range)
    {
        var now = new Date().getTime();

        return (timestamp + range > now);
    },

	serverMessagesRouter: function(event)
	{
		var data = event.originalEvent.data.split('__similarproductsVulconNamespaceMarker')[1];

		data = data && JSON.parse(data) || null;

		if (data && typeof this[data.fn] === 'function')
		{
			this[data.fn](data.data);
		}
	},

	sendMessageToServerLayer: function(fn, data)
	{
		var targetWindow = similarproducts.vulcon.serverLayerFrame.contentWindow || similarproducts.vulcon.serverLayerFrame;
		var message =
        {
            fn: fn,
            data: data
        };

        targetWindow.postMessage('__similarproductsVulconNamespaceMarker'+JSON.stringify(message), '*');
	}
};


similarproducts.vulcon.initialize();


